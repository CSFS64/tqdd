<!DOCTYPE html>
<html lang="zh-CN">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width,initial-scale=1.0">
  <title>同居匹配管理后台</title>
  <style>
    body { font-family: Arial, sans-serif; background:#121212; color:#f5f5f5; padding:1.5rem; }
    h1 { text-align:center; margin-bottom:1rem; }
    .login { margin-bottom:1rem; text-align:center; }
    input,button { padding:0.5rem; font-size:1rem; border-radius:6px; border:1px solid #444; }
    button { background:#2b68ff; color:white; border:none; cursor:pointer; }
    button:hover { background:#1f55d8; }
    table { width:100%; border-collapse:collapse; margin-top:1rem; }
    th,td { border:1px solid #444; padding:0.5rem; text-align:left; }
    th { background:#222; }
    tr:nth-child(even) { background:#1b1b1b; }
    .danger { background:#ff5555; }
    .danger:hover { background:#d33; }
    #msg { margin-top:1rem; color:#ffdd57; font-weight:bold; }
  </style>
</head>
<body>
  <h1>同居匹配管理后台</h1>

  <div class="login">
    <input id="token" type="password" placeholder="请输入管理员 Token" />
    <button onclick="loadData()">加载数据</button>
  </div>

  <div id="msg"></div>
  <table id="dataTable" hidden>
    <thead>
      <tr>
        <th>昵称</th>
        <th>联系方式</th>
        <th>时段</th>
        <th>玩法</th>
        <th>语音</th>
        <th>性别</th>
        <th>备注</th>
        <th>时间</th>
        <th>操作</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <script>
    const BASE = "https://tqdd-match.20060303jjc.workers.dev";

    async function loadData() {
      const token = document.getElementById("token").value.trim();
      if (!token) { alert("请输入 Token"); return; }

      document.getElementById("msg").textContent = "加载中…";
      try {
        const res = await fetch(`${BASE}/admin/list`, {
          headers: { "X-Admin-Token": token }
        });
        const json = await res.json();

        if (!json.ok) {
          document.getElementById("msg").textContent = "加载失败：" + (json.error || "未知错误");
          return;
        }

        const table = document.getElementById("dataTable");
        const tbody = table.querySelector("tbody");
        tbody.innerHTML = "";

        json.items.forEach(item => {
          const tr = document.createElement("tr");
          tr.innerHTML = `
            <td>${item.nickname}</td>
            <td>${item.contact}</td>
            <td>${(item.slots || []).join(", ")}</td>
            <td>${(item.modes || []).join(", ")}</td>
            <td>${item.voice ? "是" : "否"}</td>
            <td>${item.gender}</td>
            <td>${item.note || ""}</td>
            <td>${new Date(item.ts).toLocaleString()}</td>
            <td><button class="danger" onclick="delItem('${item.id}')">删除</button></td>
          `;
          tbody.appendChild(tr);
        });

        table.hidden = false;
        document.getElementById("msg").textContent = "加载完成，共 " + json.items.length + " 条记录";
      } catch (err) {
        document.getElementById("msg").textContent = "网络错误：" + err;
      }
    }

    async function delItem(id) {
      const token = document.getElementById("token").value.trim();
      if (!confirm("确定要删除这条记录吗？")) return;

      try {
        const res = await fetch(`${BASE}/admin/delete?id=${id}`, {
          method: "DELETE",
          headers: { "X-Admin-Token": token }
        });
        const json = await res.json();
        if (json.ok) {
          alert("删除成功");
          loadData();
        } else {
          alert("删除失败：" + (json.error || "未知错误"));
        }
      } catch (err) {
        alert("网络错误：" + err);
      }
    }
  </script>
</body>
</html>
